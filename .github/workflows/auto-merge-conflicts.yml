name: Auto Resolve Merge Conflicts

# Run nightly at 2 AM UTC
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  resolve-conflicts:
    name: Resolve Merge Conflicts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for proper merge operations
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Get all open pull requests
        id: get-prs
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            core.info(`Found ${pullRequests.length} open pull request(s)`);
            
            // Store PR numbers as output
            const prNumbers = pullRequests.map(pr => pr.number);
            core.setOutput('pr-numbers', JSON.stringify(prNumbers));
            core.setOutput('pr-count', pullRequests.length);
            
            return pullRequests;
      
      - name: Process pull requests
        if: steps.get-prs.outputs.pr-count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const prNumbers = JSON.parse('${{ steps.get-prs.outputs.pr-numbers }}');
            
            for (const prNumber of prNumbers) {
              try {
                core.info(`\n=== Processing PR #${prNumber} ===`);
                
                // Get PR details
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });
                
                core.info(`PR #${prNumber}: "${pr.title}"`);
                core.info(`Branch: ${pr.head.ref} -> ${pr.base.ref}`);
                core.info(`Mergeable state: ${pr.mergeable_state}`);
                core.info(`Mergeable: ${pr.mergeable}`);
                
                // Check if PR has merge conflicts
                if (pr.mergeable === false) {
                  core.warning(`PR #${prNumber} has merge conflicts. Attempting to resolve...`);
                  
                  // Attempt to resolve conflicts by merging base into head
                  try {
                    // Set up git remote for the PR
                    const headRepo = pr.head.repo ? pr.head.repo.full_name : context.repo.owner + '/' + context.repo.repo;
                    const headRef = pr.head.ref;
                    const baseRef = pr.base.ref;
                    
                    core.info(`Fetching branch ${headRef} from ${headRepo}...`);
                    
                    // Use GitHub API to attempt merge
                    // First, try to update the branch (GitHub's built-in update)
                    try {
                      await github.rest.pulls.updateBranch({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: prNumber
                      });
                      
                      core.info(`âœ“ Successfully updated PR #${prNumber} by merging ${baseRef} into ${headRef}`);
                      
                      // Add success comment
                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: prNumber,
                        body: `ðŸ¤– **Automatic Merge Conflict Resolution**\n\n` +
                              `âœ… Successfully resolved merge conflicts by merging \`${baseRef}\` into this PR branch.\n\n` +
                              `**Action:** The base branch has been merged into your PR branch.\n` +
                              `**Status:** Ready for review\n` +
                              `**Timestamp:** ${new Date().toISOString()}\n\n` +
                              `Please verify that the automatic resolution is correct and update if necessary.`
                      });
                      
                    } catch (updateError) {
                      core.warning(`Failed to auto-update PR #${prNumber}: ${updateError.message}`);
                      
                      // Comment on PR about the failure
                      let errorMessage = updateError.message;
                      let detailedMessage = '';
                      
                      if (updateError.status === 422) {
                        detailedMessage = '\n\n**Reason:** The conflicts are too complex for automatic resolution.';
                      } else if (updateError.status === 403) {
                        detailedMessage = '\n\n**Reason:** Insufficient permissions to update this branch.';
                      }
                      
                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: prNumber,
                        body: `ðŸ¤– **Automatic Merge Conflict Resolution**\n\n` +
                              `âŒ Failed to automatically resolve merge conflicts.\n\n` +
                              `**Error:** ${errorMessage}${detailedMessage}\n` +
                              `**Action Required:** Please manually resolve the conflicts.\n` +
                              `**Timestamp:** ${new Date().toISOString()}\n\n` +
                              `To resolve manually:\n` +
                              `1. Check out your branch locally\n` +
                              `2. Run: \`git merge ${baseRef}\`\n` +
                              `3. Resolve conflicts in the affected files\n` +
                              `4. Commit and push the changes`
                      });
                    }
                    
                  } catch (error) {
                    core.error(`Error processing PR #${prNumber}: ${error.message}`);
                    
                    // Add error comment
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: prNumber,
                      body: `ðŸ¤– **Automatic Merge Conflict Resolution**\n\n` +
                            `âŒ Encountered an error while attempting to resolve conflicts.\n\n` +
                            `**Error:** ${error.message}\n` +
                            `**Action Required:** Please manually resolve the conflicts.\n` +
                            `**Timestamp:** ${new Date().toISOString()}`
                    });
                  }
                  
                } else if (pr.mergeable === true) {
                  core.info(`âœ“ PR #${prNumber} has no merge conflicts`);
                } else if (pr.mergeable === null) {
                  core.info(`â³ PR #${prNumber} merge status is being calculated. Will be checked in next run.`);
                }
                
              } catch (error) {
                core.error(`Failed to process PR #${prNumber}: ${error.message}`);
                core.error(error.stack);
              }
            }
            
            core.info(`\n=== Conflict Resolution Complete ===`);
      
      - name: Summary
        if: always()
        run: |
          echo "### Auto Merge Conflict Resolution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Open PRs Checked:** ${{ steps.get-prs.outputs.pr-count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the job logs for detailed information about conflict resolution attempts." >> $GITHUB_STEP_SUMMARY
