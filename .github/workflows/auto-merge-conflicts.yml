name: Auto Resolve PR Merge Conflicts

# Run hourly to check for PR conflicts and attempt automatic resolution
on:
  schedule:
    # Run every hour at minute 0
    - cron: '0 * * * *'
  workflow_dispatch:
    # Allow manual triggering for testing

permissions:
  contents: write
  pull-requests: write

jobs:
  resolve-conflicts:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Detect and resolve PR conflicts
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "==================================="
        echo "Starting PR Conflict Detection"
        echo "==================================="

        # Get all open pull requests
        prs=$(gh pr list --state open --json number,headRefName,baseRefName,title,mergeable --limit 100)
        pr_count=$(echo "$prs" | jq '. | length')

        echo "Found $pr_count open pull request(s)"

        if [ "$pr_count" -eq 0 ]; then
          echo "No open pull requests found. Exiting."
          exit 0
        fi

        # Process each pull request
        echo "$prs" | jq -c '.[]' | while read -r pr; do
          pr_number=$(echo "$pr" | jq -r '.number')
          pr_title=$(echo "$pr" | jq -r '.title')
          head_branch=$(echo "$pr" | jq -r '.headRefName')
          base_branch=$(echo "$pr" | jq -r '.baseRefName')
          mergeable=$(echo "$pr" | jq -r '.mergeable')

          echo ""
          echo "-----------------------------------"
          echo "Processing PR #$pr_number: $pr_title"
          echo "  Head: $head_branch"
          echo "  Base: $base_branch"
          echo "  Mergeable: $mergeable"
          echo "-----------------------------------"

          # Check if PR has conflicts (mergeable is CONFLICTING)
          if [ "$mergeable" = "CONFLICTING" ]; then
            echo "âš ï¸  Conflict detected in PR #$pr_number"
            echo "Attempting to resolve conflicts..."

            # Fetch latest changes
            git fetch origin "$base_branch" 2>&1 || {
              echo "âŒ Failed to fetch base branch: $base_branch"
              echo "Error: Unable to fetch origin/$base_branch"
              continue
            }

            git fetch origin "$head_branch" 2>&1 || {
              echo "âŒ Failed to fetch head branch: $head_branch"
              echo "Error: Unable to fetch origin/$head_branch"
              continue
            }

            # Checkout the PR branch
            git checkout -B "$head_branch" "origin/$head_branch" 2>&1 || {
              echo "âŒ Failed to checkout branch: $head_branch"
              echo "Error: Unable to checkout $head_branch"
              continue
            }

            # Attempt to merge base branch
            echo "Merging $base_branch into $head_branch..."
            merge_msg="chore: auto-merge $base_branch to resolve conflicts in PR #$pr_number"
            if git merge "origin/$base_branch" -m "$merge_msg" 2>&1; then
              echo "âœ… Merge successful!"

              # Push the changes
              if git push origin "$head_branch" 2>&1; then
                echo "âœ… Successfully pushed conflict resolution for PR #$pr_number"

                # Add a comment to the PR - use echo with newlines
                comment_msg="ðŸ¤– **Automated Conflict Resolution**

                The base branch (\`$base_branch\`) has been automatically merged into this PR branch to resolve merge conflicts.

                Please review the changes and ensure everything is working as expected."
                gh pr comment "$pr_number" --body "$comment_msg" 2>&1 || echo "âš ï¸  Warning: Failed to add comment to PR #$pr_number"
              else
                echo "âŒ Failed to push conflict resolution for PR #$pr_number"
                echo "Error: Git push failed"

                # Reset the branch to its original state
                git fetch origin "$head_branch" 2>&1
                git reset --hard "origin/$head_branch" 2>&1
              fi
            else
              echo "âŒ Automatic merge failed for PR #$pr_number"
              echo "Error: Merge conflicts require manual resolution"

              # Abort the merge
              git merge --abort 2>&1 || true

              # Add a comment to the PR about the failure - use echo with newlines
              comment_msg="ðŸ¤– **Automated Conflict Resolution Failed**

              An automatic attempt to resolve merge conflicts was unsuccessful. The conflicts require manual intervention.

              Please resolve the conflicts manually by merging \`$base_branch\` into your branch."
              gh pr comment "$pr_number" --body "$comment_msg" 2>&1 || echo "âš ï¸  Warning: Failed to add comment to PR #$pr_number"
            fi

            # Return to base branch
            git checkout "$base_branch" 2>&1 || true
          else
            echo "âœ… No conflicts detected in PR #$pr_number"
          fi
        done

        echo ""
        echo "==================================="
        echo "PR Conflict Detection Complete"
        echo "==================================="
