name: Auto Resolve PR Merge Conflicts

# Run hourly to check for PR conflicts and attempt automatic resolution
on:
  schedule:
    # Run every hour at minute 0
    - cron: '0 * * * *'
  workflow_dispatch:
    # Allow manual triggering for testing

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  resolve-conflicts:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Make script executable
      run: chmod +x ./scripts/resolve_merge_conflicts.sh

    - name: Detect and resolve PR conflicts with AI
      id: resolve_conflicts
      continue-on-error: true
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_SERVER_URL: ${{ github.server_url }}
        MAX_RETRIES: 3
        LOG_DIR: /tmp/conflict-logs
      run: |
        # Run the external script
        ./scripts/resolve_merge_conflicts.sh
        exit_code=$?
        
        # Store exit code for conditional steps
        echo "script_exit_code=$exit_code" >> $GITHUB_OUTPUT
        
        # Exit with the same code from the script
        exit $exit_code

    - name: Upload conflict resolution logs
      # Only upload logs when conflicts were detected and processed (exit codes 0 or 3)
      # Note: GitHub Actions outputs are strings, so we use string comparison
      if: steps.resolve_conflicts.outputs.script_exit_code == '0' || steps.resolve_conflicts.outputs.script_exit_code == '3'
      uses: actions/upload-artifact@v4
      with:
        name: conflict-resolution-logs
        path: /tmp/conflict-logs/
        retention-days: 30

    - name: Check workflow result
      if: always()
      run: |
        exit_code="${{ steps.resolve_conflicts.outputs.script_exit_code }}"
        
        if [[ "$exit_code" == "1" ]]; then
          echo "✅ No open PRs or no conflicts detected - no action needed"
          exit 0
        elif [[ "$exit_code" == "0" ]]; then
          echo "✅ All conflicts resolved successfully"
          exit 0
        elif [[ "$exit_code" == "3" ]]; then
          echo "❌ Some conflicts could not be resolved"
          exit 1
        elif [[ "$exit_code" == "2" ]]; then
          echo "❌ Configuration or environment error"
          exit 1
        else
          echo "⚠️  Unexpected exit code: $exit_code"
          exit 1
        fi
